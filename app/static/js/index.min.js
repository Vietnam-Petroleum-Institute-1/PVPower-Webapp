let isConversationStarted=!1,isWaitingForBot=!1,conversationIdPromise=null,feedbackMessageId=null;function checkOrCreateSession(n,s){return console.log("Checking or creating session"),showWaitingBubble(),fetch("/api/session_exist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n,session_id:s})}).then(e=>e.json()).then(e=>{var t;return console.log("Session existence check:",e),1===e.result?(document.getElementById("chatContainer").style.display="flex",getConversation(n,s)):0===e.result?(e=(new Date).toISOString(),t=new Date(Date.now()+36e5).toISOString(),createSession(n,s,e,t)):(document.getElementById("chatMessages").innerHTML='<div class="message bot"><div class="message-content">Vui lòng đăng nhập để sử dụng trợ lý ảo</div></div>',void((e=document.querySelector(".chat-input"))&&(e.style.display="none")))}).catch(e=>{throw console.error("Error in checkOrCreateSession:",e),e}).finally(()=>{hideWaitingBubble()})}function createSession(t,n,e,s){return console.log("Creating session"),showWaitingBubble(),fetch("/api/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,session_id:n,start_time:e,end_time:s})}).then(e=>e.json()).then(e=>(console.log("Session creation result:",e),document.getElementById("chatContainer").style.display="flex",startConversation(t,n))).catch(e=>{throw console.error("Error in createSession:",e),e}).finally(()=>{hideWaitingBubble()})}function startConversation(e,t){return console.log("Starting conversation"),showWaitingBubble(),fetch("/api/start_conversation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,session_id:t})}).then(e=>e.json()).then(e=>{console.log("Start conversation result:",e);var e=e.conversation_id,t=(sessionStorage.setItem("conversation_id",e),document.getElementById("userInput")),n=document.getElementById("sendButton");return t&&n&&(t.disabled=!1,n.disabled=!1),isConversationStarted=!0,console.log("Conversation started, conversation_id:",e),addMessageToChat("bot","Xin chào, rất vui được hỗ trợ bạn"),e}).catch(e=>{throw console.error("Error in startConversation:",e),document.getElementById("chatMessages").innerHTML+='<div class="message bot"><div class="message-content">Sorry, something went wrong while starting the conversation.</div></div>',e}).finally(()=>{hideWaitingBubble()})}function getConversation(e,t){return console.log("Getting conversation"),showWaitingBubble(),fetch("/api/conversation_id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,session_id:t})}).then(e=>e.json()).then(e=>{console.log("Conversation ID:",e.result),sessionStorage.setItem("conversation_id",e.result);var t=document.getElementById("userInput"),n=document.getElementById("sendButton");return t&&n&&(t.disabled=!1,n.disabled=!1),isConversationStarted=!0,e.result}).catch(e=>{throw console.error("Error in getConversation:",e),e}).finally(()=>{hideWaitingBubble()})}function handleKeyPress(e){"Enter"===e.key&&!isWaitingForBot&&isConversationStarted&&sendMessage()}function sendMessage(s=null){if(!isConversationStarted||isWaitingForBot)console.log("Conversation has not started yet or still waiting for bot response.");else{var e=document.getElementById("userInput");let n=s||e.value.trim();if(""!==n){var o=new URLSearchParams(window.location.search);let t=o.get("user_id");var o=o.get("session_id"),i=sessionStorage.getItem("conversation_id");i?(addMessageToChat(s?"bot":"user",n,null),s||(e.value=""),isWaitingForBot=!0,addWaitingBubble(),fetch(`/api/message?text=${encodeURIComponent(n)}&user_id=${encodeURIComponent(t)}&session_id=${encodeURIComponent(o)}&conversation_id=`+encodeURIComponent(i)).then(e=>e.json()).then(e=>{console.log("Message sent:",e),removeWaitingBubble(),s||processBotResponse(e.result,e.message_id,n,t),isWaitingForBot=!1}).catch(e=>{console.error("Error:",e),removeWaitingBubble(),addMessageToChat("bot","Sorry, something went wrong."),isWaitingForBot=!1})):console.error("Error: conversation_id is undefined before sending message")}}}function processBotResponse(e,t,n,s){var o,i=e.match(/Domain (1|2|3|4)$/);console.log("Đây là domainMatch",i),i?(i="Domain "+i[1],addMessageToChat("bot",o=e.replace(/Domain (1|2|3|4)$/,"").trim(),t),uploadPendingFAQ(o,n,i,s)):addMessageToChat("bot",e,t)}function uploadPendingFAQ(e,t,n,s){fetch("/api/upload_pending_FAQ",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:t,answer:e,domain:n,user_id:s})}).then(e=>e.json()).then(e=>{console.log("Success:",e)}).catch(e=>{console.error("Error:",e)})}function addMessageToChat(e,t,n){var s=document.getElementById("chatMessages");let o=document.createElement("div");o.classList.add("message",e),n&&(o.dataset.messageId=n);var i=document.createElement("div");i.classList.add("message-content"),i.textContent=t,o.appendChild(i),"bot"===e&&((t=document.createElement("div")).classList.add("feedback-buttons"),(i=document.createElement("button")).classList.add("like-button"),i.innerHTML='<i class="fas fa-thumbs-up"></i>',i.onclick=()=>sendFeedback("like",n,o),(e=document.createElement("button")).classList.add("dislike-button"),e.innerHTML='<i class="fas fa-thumbs-down"></i>',e.onclick=()=>sendFeedback("dislike",n,o),t.appendChild(i),t.appendChild(e),o.appendChild(t)),s.appendChild(o),s.scrollTop=s.scrollHeight}function addWaitingBubble(){removeWaitingBubble();var e=document.getElementById("chatMessages"),t=document.createElement("div"),n=(t.classList.add("message","bot","waiting-bubble"),document.createElement("div")),s=(n.classList.add("message-content"),document.createElement("span")),o=(s.classList.add("dot"),document.createElement("span")),i=(o.classList.add("dot"),document.createElement("span"));i.classList.add("dot"),n.appendChild(s),n.appendChild(o),n.appendChild(i),t.appendChild(n),e.appendChild(t),e.scrollTop=e.scrollHeight}function removeWaitingBubble(){var e=document.getElementById("chatMessages"),t=e.querySelector(".waiting-bubble");t&&e.removeChild(t)}function showWaitingBubble(){removeWaitingBubble();var e=document.getElementById("chatMessages"),t=document.createElement("div"),n=(t.classList.add("message","bot","waiting-bubble"),document.createElement("div")),s=(n.classList.add("message-content"),document.createElement("span")),o=(s.classList.add("dot"),document.createElement("span")),i=(o.classList.add("dot"),document.createElement("span"));i.classList.add("dot"),n.appendChild(s),n.appendChild(o),n.appendChild(i),t.appendChild(n),e.appendChild(t),e.scrollTop=e.scrollHeight}function hideWaitingBubble(){removeWaitingBubble()}function submitFeedback(t,e,n,s){var o=new URLSearchParams(window.location.search),i=o.get("user_id"),o=o.get("session_id");fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i,session_id:o,messageId:e,feedbackType:t,feedbackText:n})}).then(e=>e.json()).then(e=>{console.log("Feedback sent:",e),("dislike"===t?s.querySelector(".dislike-button"):s.querySelector(".like-button")).classList.add("selected")}).catch(e=>{console.error("Error sending feedback:",e)})}function sendFeedback(e,t,n){var s=n.querySelector(".feedback-buttons"),o=s.querySelector(".like-button"),s=s.querySelector(".dislike-button");o.disabled=!0,s.disabled=!0,"dislike"===e?(feedbackMessageId=t,showModal()):submitFeedback(e,t,"",n)}function showModal(){document.getElementById("feedbackModal").style.display="block"}function closeModal(){document.getElementById("feedbackModal").style.display="none",feedbackMessageId=null}function submitDislikeFeedback(){var e=document.getElementById("feedbackText").value,t=document.querySelector(`.message[data-message-id="${feedbackMessageId}"]`);submitFeedback("dislike",feedbackMessageId,e,t),closeModal()}window.onload=function(){console.log("Window loaded");var e=new URLSearchParams(window.location.search);let t=e.get("user_id"),n=e.get("session_id");console.log("User ID:",t,"Session ID:",n),fetch("/api/user_exist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t})}).then(e=>e.json()).then(e=>{console.log("User existence check:",e),e.result?conversationIdPromise=checkOrCreateSession(t,n):(document.getElementById("chatMessages").innerHTML='<div class="message bot"><div class="message-content">Vui lòng đăng nhập để sử dụng trợ lý ảo</div></div>',(e=document.querySelector(".chat-input"))&&(e.style.display="none"))}).catch(e=>{console.error("Error:",e)})};