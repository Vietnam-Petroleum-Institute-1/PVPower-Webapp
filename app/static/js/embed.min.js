(function () {
  // Tạo nút "Chat with us"
  const chatbotButton = document.createElement('button');
  chatbotButton.innerText = 'Chat with us';
  chatbotButton.style.position = 'fixed';
  chatbotButton.style.bottom = '20px';
  chatbotButton.style.right = '20px';
  chatbotButton.style.backgroundColor = '#007bff';
  chatbotButton.style.color = 'white';
  chatbotButton.style.border = 'none';
  chatbotButton.style.borderRadius = '50px';
  chatbotButton.style.padding = '10px 20px';
  chatbotButton.style.cursor = 'pointer';
  chatbotButton.style.zIndex = '1000';
  document.body.appendChild(chatbotButton);

  // Tạo khung chứa iframe chatbot
  const chatbotContainer = document.createElement('div');
  chatbotContainer.style.position = 'fixed';
  chatbotContainer.style.bottom = '70px';
  chatbotContainer.style.right = '20px';
  chatbotContainer.style.width = '400px';
  chatbotContainer.style.height = '600px';
  chatbotContainer.style.zIndex = '1000';
  chatbotContainer.style.display = 'none'; // Bắt đầu ẩn
  chatbotContainer.style.borderRadius = '20px'; // Bo tròn 4 góc
  chatbotContainer.style.overflow = 'hidden'; // Đảm bảo nội dung không tràn ra ngoài
  document.body.appendChild(chatbotContainer);
  let iframeCreated = false; // Biến để kiểm tra iframe đã được tạo hay chưa

  // Hàm để lấy token từ API
  function getTokenAndCreateIframe() {
    fetch(window.ChatbotConfig.baseUrl+'/api/verify_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ token: window.ChatbotConfig.token })
    })
    .then(response => response.json())
    .then(data => {
      if (data.token) {
        // Chỉ tạo iframe khi token đã được xác nhận
        console.log('Token nhận được từ API:', data.token);
        const iframe = document.createElement('iframe');
        iframe.src = window.ChatbotConfig.baseUrl + "/chatbot?token=" + data.token;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        chatbotContainer.appendChild(iframe);
        iframeCreated = true; // Đánh dấu đã tạo iframe
        chatbotContainer.style.display = 'block'; // Hiển thị iframe
      } else {
        console.error("Không nhận được token");
      }
    })
    .catch(error => {
      console.error("Lỗi khi lấy token:", error);
    });
  }

  // Sự kiện bật/tắt chatbot khi nhấn nút
  chatbotButton.onclick = () => {
    if (chatbotContainer.style.display === 'none') {
      // Chỉ tạo iframe khi lần đầu bấm nút
      if (!iframeCreated && window.ChatbotConfig) {
        console.log("Lấy token và tạo iframe...");
        getTokenAndCreateIframe();
      } else {
        chatbotContainer.style.display = 'block'; // Hiển thị nếu đã tạo iframe trước đó
      }
    } else {
      chatbotContainer.style.display = 'none';
    }
  };
})();
