(function () {
  // Tạo nút "Chat with us"
  const chatbotButton = document.createElement('button');
  chatbotButton.innerText = 'Chat with us';
  chatbotButton.style.position = 'fixed';
  chatbotButton.style.bottom = '20px';
  chatbotButton.style.right = '20px';
  chatbotButton.style.backgroundColor = '#007bff';
  chatbotButton.style.color = 'white';
  chatbotButton.style.border = 'none';
  chatbotButton.style.borderRadius = '50px';
  chatbotButton.style.padding = '10px 20px';
  chatbotButton.style.cursor = 'pointer';
  chatbotButton.style.zIndex = '1000';
  document.body.appendChild(chatbotButton);

  // Tạo khung chứa iframe chatbot
  const chatbotContainer = document.createElement('div');
  chatbotContainer.style.position = 'fixed';
  chatbotContainer.style.bottom = '70px';
  chatbotContainer.style.right = '20px';
  chatbotContainer.style.width = '400px';
  chatbotContainer.style.height = '600px';
  chatbotContainer.style.zIndex = '1000';
  chatbotContainer.style.display = 'none'; // Bắt đầu ẩn
  chatbotContainer.style.borderRadius = '20px'; // Bo tròn 4 góc
  chatbotContainer.style.overflow = 'hidden'; // Đảm bảo nội dung không tràn ra ngoài
  document.body.appendChild(chatbotContainer);

  let iframeCreated = false; // Biến để kiểm tra iframe đã được tạo hay chưa
  let iframeReloaded = false; // Biến để đánh dấu lần đầu tiên iframe được reload
  let iframe = null; // Biến lưu trữ iframe để reload

  // Sự kiện bật/tắt chatbot khi nhấn nút
  chatbotButton.onclick = () => {
    if (chatbotContainer.style.display === 'none') {
      // Hiển thị ngay lập tức khung iframe
      chatbotContainer.style.display = 'block';

      // Chỉ reload trong lần bấm nút đầu tiên và đợi 2 giây để load nội dung
      if (!iframeReloaded) {
        chatbotButton.innerText = 'Đang tải...'; // Hiển thị trạng thái tải

        // Đợi 2 giây trước khi load nội dung iframe
        setTimeout(() => {
          chatbotButton.innerText = 'Chat with us'; // Đặt lại văn bản nút

          if (!iframeCreated && window.ChatbotConfig) {
            const e = window.ChatbotConfig;
            iframe = document.createElement('iframe');
            iframe.src = e.baseUrl + "/chatbot?token=" + e.token;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            chatbotContainer.appendChild(iframe);
            iframeCreated = true; // Đánh dấu đã tạo iframe lần đầu
          } else if (iframe) {
            // Reload lại iframe lần đầu tiên
            iframe.src = iframe.src;
          }
          iframeReloaded = true; // Đánh dấu đã reload iframe lần đầu tiên
        }, 2000); // Đặt thời gian chờ 2 giây để load nội dung iframe
      }
    } else {
      chatbotContainer.style.display = 'none';
    }
  };
})();
