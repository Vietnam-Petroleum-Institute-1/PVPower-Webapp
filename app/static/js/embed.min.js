(function () {
  // Tạo nút "Chat with us"
  const chatbotButton = document.createElement('button');
  chatbotButton.innerText = 'Chat with us';
  chatbotButton.style.position = 'fixed';
  chatbotButton.style.bottom = '20px';
  chatbotButton.style.right = '20px';
  chatbotButton.style.backgroundColor = '#007bff';
  chatbotButton.style.color = 'white';
  chatbotButton.style.border = 'none';
  chatbotButton.style.borderRadius = '50px';
  chatbotButton.style.padding = '10px 20px';
  chatbotButton.style.cursor = 'pointer';
  chatbotButton.style.zIndex = '1000';
  document.body.appendChild(chatbotButton);

  // Tạo khung chứa iframe chatbot
  const chatbotContainer = document.createElement('div');
  chatbotContainer.style.position = 'fixed';
  chatbotContainer.style.bottom = '70px';
  chatbotContainer.style.right = '20px';
  chatbotContainer.style.width = '400px';
  chatbotContainer.style.height = '600px';
  chatbotContainer.style.zIndex = '1000';
  chatbotContainer.style.display = 'none'; // Bắt đầu ẩn
  chatbotContainer.style.borderRadius = '20px'; // Bo tròn 4 góc
  chatbotContainer.style.overflow = 'hidden'; // Đảm bảo nội dung không tràn ra ngoài
  document.body.appendChild(chatbotContainer);
  
  let iframeCreated = false; // Biến để kiểm tra iframe đã được tạo hay chưa

  // Sự kiện bật/tắt chatbot khi nhấn nút
  chatbotButton.onclick = () => {
    if (!iframeCreated && window.ChatbotConfig) {
      const e = window.ChatbotConfig;
      
      // Hiện khung và bắt đầu tải iframe sau khi xác nhận token
      chatbotContainer.style.display = 'block';
      showLoadingSpinner(chatbotContainer); // Hiển thị spinner trong khi đợi

      // Gọi API để kiểm tra token
      fetch(e.baseUrl + "/api/verify_token", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ token: e.token }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.user_id && data.session_id) {
          // Khi nhận được token hợp lệ, hiển thị iframe
          const iframe = document.createElement('iframe');
          iframe.src = e.baseUrl + "/chatbot?token=" + e.token;
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          chatbotContainer.innerHTML = ''; // Xoá spinner
          chatbotContainer.appendChild(iframe);
          iframeCreated = true; // Đánh dấu đã tạo iframe
        } else {
          console.error("Token không hợp lệ, không thể hiển thị chatbot.");
        }
      })
      .catch(error => {
        console.error("Lỗi xác thực token:", error);
      });
    } else if (!window.ChatbotConfig) {
      console.error("ChatbotConfig không được định nghĩa");
    } else {
      // Chỉ ẩn/hiện khung nếu iframe đã được tạo trước đó
      chatbotContainer.style.display = chatbotContainer.style.display === 'none' ? 'block' : 'none';
    }
  };

  // Hàm hiển thị spinner loading
  function showLoadingSpinner(container) {
    const spinner = document.createElement('div');
    spinner.className = 'loading-spinner';
    spinner.style.width = '50px';
    spinner.style.height = '50px';
    spinner.style.border = '5px solid rgba(0, 0, 0, 0.1)';
    spinner.style.borderTop = '5px solid #007bff';
    spinner.style.borderRadius = '50%';
    spinner.style.animation = 'spin 1s linear infinite';
    spinner.style.margin = 'auto';
    spinner.style.position = 'relative';
    spinner.style.top = '50%';
    container.appendChild(spinner);
  }
})();
